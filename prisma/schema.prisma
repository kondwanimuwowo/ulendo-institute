// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
}

enum Interval {
  MONTH
  YEAR
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  name              String?
  passwordHash      String
  role              UserRole       @default(STUDENT)
  instructorApproved Boolean       @default(false)
  instructorBio     String?
  instructorPhoto   String?
  instructorLinks   Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  subscriptions     Subscription[]
  courses           Course[]       @relation("InstructorCourses")
  enrollments       Enrollment[]
  lessonProgress    LessonProgress[]
}

model Plan {
  id            String        @id @default(cuid())
  name          String
  slug          String        @unique
  priceCents    Int
  interval      Interval
  trialDays     Int           @default(0)
  externalId    String?       // Lenco plan ID
  features      Json
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  subscriptions Subscription[]
}

model Subscription {
  id                      String             @id @default(cuid())
  userId                  String
  planId                  String
  status                  SubscriptionStatus @default(PENDING)
  externalSubscriptionId  String?            // Lenco subscription ID
  externalCustomerId      String?            // Lenco customer ID
  currentPeriodStart      DateTime?
  currentPeriodEnd        DateTime?
  cancelAtPeriodEnd       Boolean            @default(false)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  
  user                    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                    Plan               @relation(fields: [planId], references: [id])
  
  @@index([userId])
  @@index([status])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  
  courses   Course[]
}

model Course {
  id           String       @id @default(cuid())
  title        String
  slug         String       @unique
  description  String
  thumbnail    String?
  categoryId   String
  instructorId String
  published    Boolean      @default(false)
  isFree       Boolean      @default(false)
  createdAt    DateTime     @default(now())

  updatedAt    DateTime     @updatedAt
  
  category     Category     @relation(fields: [categoryId], references: [id])
  instructor   User         @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)
  lessons      Lesson[]
  enrollments  Enrollment[]
  
  @@index([slug])
  @@index([published])
  @@index([instructorId])
}

model Lesson {
  id        String   @id @default(cuid())
  title     String
  content   String   // Markdown content
  videoUrl  String?  // YouTube URL for MVP
  order     Int
  courseId  String
  isFree    Boolean  @default(false) // First lesson is free
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress  LessonProgress[]
  
  @@index([courseId])
  @@index([order])
}

model Enrollment {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  enrolledAt DateTime @default(now())
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@index([userId])
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  progress    Int       @default(0) // Percentage 0-100
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@index([userId])
}
